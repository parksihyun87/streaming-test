<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“¡ ì†¡ì‹ ì í™”ë©´</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    video {
      width: 100%;
      max-width: 640px;
      height: auto;
      border: 2px solid #333;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    #chatContainer {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      background-color: #f9f9f9;
    }
    
    #chatLog {
      height: 200px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 10px;
      background-color: white;
      border-radius: 4px;
      margin-bottom: 10px;
      font-size: 14px;
    }
    
    #chatInputContainer {
      display: flex;
      gap: 10px;
    }
    
    #chatInput {
      flex: 1;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }
    
    #sendBtn {
      padding: 8px 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    #sendBtn:hover {
      background-color: #0056b3;
    }
    
    #status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
      font-weight: bold;
    }
    
    .status-connected {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status-disconnected {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
  </style>
</head>
<body>
  <h1>ğŸ“¡ ì†¡ì‹ ì í™”ë©´</h1>
  <video id="localVideo" autoplay playsinline muted></video>
  
  <div id="chatContainer">
    <h3>ğŸ’¬ ì±„íŒ…</h3>
    <div id="chatLog"></div>
    <div id="chatInputContainer">
      <input type="text" id="chatInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off" />
      <button id="sendBtn">ì „ì†¡</button>
    </div>
  </div>
  
  <div id="status" class="status-disconnected">ì—°ê²° ì¤‘...</div>

  <script>
    const senderId = "sender";
    const ws = new WebSocket("ws://localhost:8080");
    const localVideo = document.getElementById("localVideo");
    const chatInput = document.getElementById("chatInput");
    const chatLog = document.getElementById("chatLog");
    const sendBtn = document.getElementById("sendBtn");
    const status = document.getElementById("status");

    let localStream = null;
    const peerConnections = new Map(); // viewerId -> RTCPeerConnection
    let isConnected = false;

    // WebSocket ì—°ê²° ì²˜ë¦¬
    ws.onopen = () => {
      console.log("ğŸ”— WebSocket ì—°ê²°ë¨");
      updateStatus("WebSocket ì—°ê²°ë¨", true);
      initMedia();
    };

    ws.onclose = () => {
      console.log("âŒ WebSocket ì—°ê²° ì¢…ë£Œ");
      updateStatus("ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤", false);
      isConnected = false;
    };

    ws.onerror = (error) => {
      console.error("ğŸš¨ WebSocket ì˜¤ë¥˜:", error);
      updateStatus("ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤", false);
    };

    ws.onmessage = async (event) => {
      try {
        const data = JSON.parse(event.data);
        console.log("ğŸ“¨ ë©”ì‹œì§€ ìˆ˜ì‹ :", data);

        switch (data.type) {
          case "viewer-joined":
            await handleViewerJoined(data.viewerId);
            break;
          case "answer":
            await handleAnswer(data);
            break;
          case "candidate":
            await handleCandidate(data);
            break;
          case "viewer-left":
            handleViewerLeft(data.viewerId);
            break;
          case "chat":
            appendChatMessage(data.from, data.message);
            break;
          default:
            console.warn("âš ï¸ ì•Œ ìˆ˜ ì—†ëŠ” ë©”ì‹œì§€ íƒ€ì…:", data.type);
        }
      } catch (error) {
        console.error("âŒ ë©”ì‹œì§€ ì²˜ë¦¬ ì˜¤ë¥˜:", error);
      }
    };

    // ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ ì´ˆê¸°í™”
    async function initMedia() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ 
          video: true, 
          audio: true 
        });
        localVideo.srcObject = localStream;
        
        // ì†¡ì‹ ì ì—­í•  ë“±ë¡
        ws.send(JSON.stringify({ role: "sender" }));
        updateStatus("ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ ì¤€ë¹„ ì™„ë£Œ", true);
        isConnected = true;
        
        console.log("ğŸ¥ ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ íšë“ ì™„ë£Œ");
      } catch (error) {
        console.error("âŒ ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ ì˜¤ë¥˜:", error);
        updateStatus("ì¹´ë©”ë¼/ë§ˆì´í¬ ì ‘ê·¼ ì‹¤íŒ¨", false);
      }
    }

    // ìƒˆ ë·°ì–´ ì ‘ì† ì²˜ë¦¬
    async function handleViewerJoined(viewerId) {
      console.log(`ğŸ‘€ ìƒˆ ë·°ì–´ ì ‘ì†: ${viewerId}`);
      
      if (!localStream) {
        console.error("âŒ ë¡œì»¬ ìŠ¤íŠ¸ë¦¼ì´ ì—†ìŠµë‹ˆë‹¤");
        return;
      }

      const pc = createPeerConnection(viewerId);
      
      try {
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        ws.send(JSON.stringify({
          type: "offer",
          from: senderId,
          to: viewerId,
          sdp: offer
        }));
        
        console.log(`ğŸ“¤ Offer ì „ì†¡: ${viewerId}`);
      } catch (error) {
        console.error(`âŒ Offer ìƒì„± ì‹¤íŒ¨ (${viewerId}):`, error);
      }
    }

    // Answer ì²˜ë¦¬
    async function handleAnswer(data) {
      const pc = peerConnections.get(data.from);
      if (!pc) {
        console.warn(`âš ï¸ PeerConnection ì—†ìŒ: ${data.from}`);
        return;
      }

      try {
        await pc.setRemoteDescription(data.sdp);
        console.log(`âœ… Answer ì²˜ë¦¬ ì™„ë£Œ: ${data.from}`);
      } catch (error) {
        console.error(`âŒ Answer ì²˜ë¦¬ ì‹¤íŒ¨ (${data.from}):`, error);
      }
    }

    // ICE Candidate ì²˜ë¦¬
    async function handleCandidate(data) {
      const pc = peerConnections.get(data.from);
      if (!pc) {
        console.warn(`âš ï¸ PeerConnection ì—†ìŒ: ${data.from}`);
        return;
      }

      try {
        await pc.addIceCandidate(data.candidate);
        console.log(`âœ… ICE Candidate ì¶”ê°€: ${data.from}`);
      } catch (error) {
        console.warn(`âš ï¸ ICE Candidate ì¶”ê°€ ì‹¤íŒ¨ (${data.from}):`, error);
      }
    }

    // ë·°ì–´ ì—°ê²° í•´ì œ ì²˜ë¦¬
    function handleViewerLeft(viewerId) {
      const pc = peerConnections.get(viewerId);
      if (pc) {
        pc.close();
        peerConnections.delete(viewerId);
        console.log(`ğŸ‘‹ ë·°ì–´ ì—°ê²° í•´ì œ: ${viewerId}`);
      }
    }

    // PeerConnection ìƒì„±
    function createPeerConnection(viewerId) {
      const pc = new RTCPeerConnection({
        iceServers: [
          { urls: "stun:stun.l.google.com:19302" },
          { urls: "stun:stun1.l.google.com:19302" }
        ]
      });

      peerConnections.set(viewerId, pc);

      // ë¡œì»¬ ìŠ¤íŠ¸ë¦¼ íŠ¸ë™ ì¶”ê°€
      localStream.getTracks().forEach(track => {
        pc.addTrack(track, localStream);
      });

      // ICE Candidate ì²˜ë¦¬
      pc.onicecandidate = (event) => {
        if (event.candidate) {
          ws.send(JSON.stringify({
            type: "candidate",
            from: senderId,
            to: viewerId,
            candidate: event.candidate
          }));
        }
      };

      // ì—°ê²° ìƒíƒœ ëª¨ë‹ˆí„°ë§
      pc.onconnectionstatechange = () => {
        console.log(`ğŸ”— ì—°ê²° ìƒíƒœ (${viewerId}): ${pc.connectionState}`);
      };

      pc.oniceconnectionstatechange = () => {
        console.log(`ğŸ§Š ICE ìƒíƒœ (${viewerId}): ${pc.iceConnectionState}`);
      };

      return pc;
    }

    // ì±„íŒ… ë©”ì‹œì§€ ì¶”ê°€
    function appendChatMessage(sender, message) {
      const div = document.createElement("div");
      div.style.marginBottom = "5px";
      div.innerHTML = `<strong>${escapeHtml(sender)}:</strong> ${escapeHtml(message)}`;
      chatLog.appendChild(div);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    // ì±„íŒ… ì „ì†¡
    function sendChat() {
      const message = chatInput.value.trim();
      if (!message || !isConnected) return;

      ws.send(JSON.stringify({ 
        type: "chat", 
        from: senderId, 
        message: message 
      }));
      
      appendChatMessage("ë‚˜", message);
      chatInput.value = "";
    }

    // ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateStatus(message, connected) {
      status.textContent = message;
      status.className = connected ? "status-connected" : "status-disconnected";
    }

    // HTML ì´ìŠ¤ì¼€ì´í”„
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    sendBtn.addEventListener("click", sendChat);
    chatInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        sendChat();
      }
    });

    // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì •ë¦¬
    window.addEventListener("beforeunload", () => {
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
      }
      peerConnections.forEach(pc => pc.close());
      ws.close();
    });
  </script>
</body>
</html>