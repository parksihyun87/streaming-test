<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ìˆ˜ì‹ ì í™”ë©´</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      color: #333;
    }

    h1 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 25px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }

    .section-container {
      background-color: #ffffff;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
      padding: 25px;
      margin-bottom: 25px;
      width: 100%;
      max-width: 800px;
      box-sizing: border-box;
    }

    .section-container h3 {
      color: #34495e;
      border-bottom: 2px solid #ecf0f1;
      padding-bottom: 12px;
      margin-top: 0;
      margin-bottom: 20px;
      text-align: center;
    }

    video {
      max-width: 800px;
      width: 100%;
      height: auto;
      border: 4px solid #2c3e50;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.25);
      background: #000;
      margin-bottom: 25px;
      display: block; /* Ensures video is a block element for margin auto */
    }

    .input-group {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      align-items: center;
      flex-wrap: wrap;
    }

    .input-group label {
      font-weight: bold;
      color: #555;
      white-space: nowrap;
    }

    .input-group input[type="text"], .input-group input[type="number"] {
      flex: 1;
      padding: 10px 15px;
      border: 1px solid #ced4da;
      border-radius: 8px;
      font-size: 16px;
      min-width: 120px;
    }

    .input-group button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background: #007bff;
      color: white;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.3s ease, transform 0.2s ease;
    }

    .input-group button:hover {
      background: #0056b3;
      transform: translateY(-1px);
    }

    .input-group button:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }

    .action-buttons {
      display: flex;
      gap: 15px;
      margin: 20px 0;
      flex-wrap: wrap;
      justify-content: center;
    }

    .like-btn, .star-balloon-btn {
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 30px;
      font-size: 17px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: bold;
    }

    .like-btn {
      background: linear-gradient(45deg, #ff6b6b, #ff5252);
    }
    .like-btn:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
    }

    .star-balloon-btn {
      background: linear-gradient(45deg, #ffd700, #ffb300);
    }
    .star-balloon-btn:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
    }
    .star-balloon-btn:disabled, .like-btn:disabled {
      background: #cccccc;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    #chatLog {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 15px;
      height: 250px;
      overflow-y: auto;
      color: #333;
      font-size: 15px;
      line-height: 1.6;
      border: 1px solid #e0e6ed;
    }

    .chat-message {
      margin-bottom: 8px;
      padding: 8px 12px;
      border-radius: 8px;
      background: #e9ecef;
      word-wrap: break-word;
    }
    .chat-message strong {
        color: #007bff;
    }

    .system-message {
      color: #6c757d;
      font-style: italic;
      text-align: center;
      margin: 10px 0;
      font-size: 14px;
      padding: 5px;
      border-radius: 5px;
      background: #e2e6ea;
    }
    .effect-message {
      background: linear-gradient(90deg, #ffedd5, #fef3c7);
      color: #8a6d3b;
      padding: 12px 18px;
      border-radius: 10px;
      margin: 8px 0;
      font-weight: bold;
      border: 2px solid #fce891;
      box-shadow: 0 4px 15px rgba(255, 215, 0, 0.5);
      animation: sparkle 1s ease-in-out;
      text-align: center;
    }

    @keyframes sparkle {
      0% { transform: scale(0.8); opacity: 0; }
      50% { transform: scale(1.1); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }

    #chatInputContainer {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    #chatInput {
      flex: 1;
      padding: 10px 15px;
      border: 1px solid #ced4da;
      border-radius: 8px;
      background: #f8f9fa;
      color: #333;
      font-size: 16px;
    }

    #sendBtn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background: #2196F3;
      color: white;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.3s ease;
    }
    #sendBtn:hover {
      background: #1976D2;
    }
    #sendBtn:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }

    #status {
      margin-top: 25px;
      padding: 15px;
      border-radius: 10px;
      font-weight: bold;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      transition: background-color 0.3s ease, color 0.3s ease;
      width: 100%;
      max-width: 800px;
    }

    .status-connected {
      background: #e6ffed;
      color: #1a7e3d;
      border: 1px solid #a3e0c0;
    }

    .status-disconnected {
      background: #ffe6e6;
      color: #c93b3b;
      border: 1px solid #f2a7a7;
    }

    .status-waiting {
      background: #fff3e0;
      color: #e67e22;
      border: 1px solid #ffd591;
    }

    #viewerList {
      background-color: #e9ecef;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
    }
    #viewerList ul {
      list-style: none;
      padding: 0;
      max-height: 100px;
      overflow-y: auto;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      background-color: #f8f9fa;
      padding: 10px;
    }
    #viewerList li {
      padding: 5px 0;
      border-bottom: 1px dashed #ced4da;
      font-size: 14px;
      color: #495057;
    }
    #viewerList li:last-child {
      border-bottom: none;
    }
  </style>
</head>
<body>
  <h1>ğŸ‘ï¸ ìˆ˜ì‹ ì í™”ë©´</h1>
  
  <div class="section-container">
    <h3>ğŸšª ë°© ì…ì¥ ì„¤ì •</h3>
    <div class="input-group">
      <label for="roomIdInput">ë°© ID:</label>
      <input type="text" id="roomIdInput" placeholder="ì…ì¥í•  ë°© IDë¥¼ ì…ë ¥í•˜ì„¸ìš”" value="defaultRoom" />
      <button id="enterRoomBtn">ë°© ì…ì¥</button>
    </div>
    <div class="input-group">
      <label for="nicknameInput">ë‹‰ë„¤ì„:</label>
      <input type="text" id="nicknameInput" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" value="ìµëª…" />
      <button id="changeNicknameBtn">ë³€ê²½</button>
    </div>
    <div id="currentRoomDisplay" style="text-align: center; margin-top: 10px; font-weight: bold; color: #555;">
      í˜„ì¬ ë°©: <span id="displayRoomId">ì„ íƒ ì•ˆë¨</span>
    </div>
  </div>

  <video id="remoteVideo" autoplay playsinline controls></video>
  
  <div class="action-buttons">
    <button id="likeBtn" class="like-btn" disabled>â¤ï¸ ì¢‹ì•„ìš”</button>
    <div class="input-group">
      <label>ë³„í’ì„ :</label>
      <input type="number" id="starBalloonInput" class="star-balloon-input" min="1" max="100000" value="1" />
      <button id="starBalloonBtn" class="star-balloon-btn" disabled>â­ ë³´ë‚´ê¸°</button>
    </div>
  </div>
  
  <div class="section-container">
    <h3>ğŸ’¬ ì±„íŒ…</h3>
    <div id="chatLog"></div>
    <div id="chatInputContainer">
      <input type="text" id="chatInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off" />
      <button id="sendBtn" disabled>ì „ì†¡</button>
    </div>
  </div>

  <div class="section-container">
    <h3>ğŸ‘¥ ì ‘ì† ì¤‘ì¸ ì‹œì²­ì (<span id="viewerCount">0</span>ëª…)</h3>
    <div id="viewerList">
      <ul id="activeViewers">
        </ul>
    </div>
  </div>
  
  <div id="status" class="status-disconnected">ì—°ê²° ì¤‘...</div>

  <script>
    const viewerId = Math.random().toString(36).substr(2, 9); // ê³ ìœ í•œ ìˆ˜ì‹ ì ID
    const ws = new WebSocket("ws://192.168.0.63:8080");
    const remoteVideo = document.getElementById("remoteVideo");
    const chatInput = document.getElementById("chatInput");
    const chatLog = document.getElementById("chatLog");
    const sendBtn = document.getElementById("sendBtn");
    const status = document.getElementById("status");
    const nicknameInput = document.getElementById("nicknameInput");
    const changeNicknameBtn = document.getElementById("changeNicknameBtn");
    const likeBtn = document.getElementById("likeBtn");
    const starBalloonBtn = document.getElementById("starBalloonBtn");
    const starBalloonInput = document.getElementById("starBalloonInput");
    const roomIdInput = document.getElementById("roomIdInput");
    const enterRoomBtn = document.getElementById("enterRoomBtn");
    const displayRoomId = document.getElementById("displayRoomId");
    const activeViewersList = document.getElementById("activeViewers");
    const viewerCountDisplay = document.getElementById("viewerCount");

    let pc = null;
    let iceCandidateQueue = [];
    let isWsConnected = false;
    let hasEnteredRoom = false; // ë°© ì…ì¥ ì—¬ë¶€
    let currentNickname = "ìµëª…";
    let currentRoomId = null; // í˜„ì¬ ì…ì¥í•œ ë°© ID

    // ì´ˆê¸° ë‹‰ë„¤ì„ ì„¤ì •
    nicknameInput.value = currentNickname;

    // WebSocket ì—°ê²° ì²˜ë¦¬
    ws.onopen = () => {
      console.log(`ğŸ”— WebSocket ì—°ê²°ë¨ (ID: ${viewerId})`);
      isWsConnected = true;
      updateStatus("ì‹œê·¸ë„ë§ ì„œë²„ì— ì—°ê²°ë¨. ë°©ì— ì…ì¥í•´ì£¼ì„¸ìš”.", "status-waiting");
      enterRoomBtn.disabled = false; // ì—°ê²°ë˜ë©´ ë°© ì…ì¥ ë²„íŠ¼ í™œì„±í™”
    };

    ws.onclose = () => {
      console.log("âŒ WebSocket ì—°ê²° ì¢…ë£Œ");
      isWsConnected = false;
      hasEnteredRoom = false;
      updateStatus("ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.", "status-disconnected");
      disableInteractionButtons();
      if (pc) {
        pc.close();
        pc = null;
      }
      remoteVideo.srcObject = null; // ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ í•´ì œ
      appendSystemMessage("ì„œë²„ì™€ì˜ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.");
      displayRoomId.textContent = "ì—°ê²° ëŠê¹€";
      updateViewerList([]);
    };

    ws.onerror = (error) => {
      console.error("ğŸš¨ WebSocket ì˜¤ë¥˜:", error);
      updateStatus("ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "status-disconnected");
    };

    ws.onmessage = async (event) => {
      try {
        const data = JSON.parse(event.data);
        console.log("ğŸ“¨ ë©”ì‹œì§€ ìˆ˜ì‹ :", data);

        switch (data.type) {
          case "offer":
            if (data.roomId === currentRoomId) { // í˜„ì¬ ë°©ì˜ offerë§Œ ì²˜ë¦¬
                await handleOffer(data);
                appendSystemMessage(`ğŸ¥ ì†¡ì‹ ìê°€ ìŠ¤íŠ¸ë¦¬ë°ì„ ì‹œì‘í–ˆìŠµë‹ˆë‹¤.`);
            } else {
                console.warn(`ë‹¤ë¥¸ ë°©(${data.roomId})ì˜ offer ìˆ˜ì‹ , ë¬´ì‹œí•¨.`);
            }
            break;
          case "candidate":
            if (data.roomId === currentRoomId) { // í˜„ì¬ ë°©ì˜ candidateë§Œ ì²˜ë¦¬
                await handleCandidate(data);
            }
            break;
          case "chat":
            appendChatMessage(data.from, data.message);
            break;
          case "like":
            // ë³¸ì¸ì´ ë³´ë‚¸ ì¢‹ì•„ìš”ëŠ” ì´ë¯¸ ë¡œì»¬ì—ì„œ ì²˜ë¦¬í–ˆìœ¼ë¯€ë¡œ, ì„œë²„ì—ì„œ ì˜¨ ê²ƒì€ ë¬´ì‹œ (ì¤‘ë³µ ë°©ì§€)
            // ì•„ë‹ˆë©´ ë³¸ì¸ì´ ë³´ë‚¸ ë©”ì‹œì§€ì„ì„ í™•ì¸í•˜ê³  ë‹¤ë¥¸ ë©”ì‹œì§€ ì²˜ë¦¬ ë¡œì§ì„ ì¶”ê°€í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
            // ì—¬ê¸°ì„œëŠ” ëª¨ë“  ì¢‹ì•„ìš” ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬í•˜ë„ë¡ ìœ ì§€í•˜ì—¬, ë¡œì»¬ í”¼ë“œë°±ê³¼ ë³„ë„ë¡œ ì„œë²„ë¡œë¶€í„°ì˜ í™•ì¸ ë©”ì‹œì§€ë¡œ ê°„ì£¼í•©ë‹ˆë‹¤.
            // ë” ì •êµí•˜ê²Œ í•˜ë ¤ë©´ ë©”ì‹œì§€ì— UUID ë“±ì„ ë„£ì–´ ì¤‘ë³µì„ ì œê±°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            handleLikeUpdate(data);
            break;
          case "star-balloon":
            // ë³¸ì¸ì´ ë³´ë‚¸ ë³„í’ì„ ì€ ì´ë¯¸ ë¡œì»¬ì—ì„œ ì²˜ë¦¬í–ˆìœ¼ë¯€ë¡œ, ì„œë²„ì—ì„œ ì˜¨ ê²ƒì€ ë¬´ì‹œ (ì¤‘ë³µ ë°©ì§€)
            handleStarBalloon(data);
            break;
          case "nickname-change":
            handleNicknameChange(data);
            break;
          case "sender-available":
            if (data.roomId === currentRoomId) {
                appendSystemMessage(`âœ… ì†¡ì‹ ìê°€ ë°©ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤. ê³§ ìŠ¤íŠ¸ë¦¼ì´ ì‹œì‘ë©ë‹ˆë‹¤.`);
                // ì†¡ì‹ ìê°€ ë‚˜ê°”ë‹¤ê°€ ë‹¤ì‹œ ë“¤ì–´ì™”ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•˜ì—¬ Offer ì¬ìš”ì²­ ë¡œì§ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                // í˜„ì¬ëŠ” ì†¡ì‹ ìê°€ ë“¤ì–´ì˜¤ë©´ Offerë¥¼ ë³´ë‚¸ë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.
            }
            break;
          case "no-sender-available":
            if (data.roomId === currentRoomId) {
                updateStatus(`ë°© "${data.roomId}"ì— ì†¡ì‹ ìê°€ ì—†ìŠµë‹ˆë‹¤.`, "status-waiting");
                appendSystemMessage(`âš ï¸ ë°© "${data.roomId}"ì— ì†¡ì‹ ìê°€ í˜„ì¬ ì—†ìŠµë‹ˆë‹¤. ëŒ€ê¸° ì¤‘...`);
                disableInteractionButtons(); // ì†¡ì‹ ì ì—†ìœ¼ë©´ ì±„íŒ…/ì•¡ì…˜ ë¹„í™œì„±í™”
            }
            break;
          case "sender-disconnected":
            if (data.roomId === currentRoomId) {
                updateStatus(`ë°© "${data.roomId}"ì˜ ì†¡ì‹ ìê°€ ì—°ê²°ì„ ëŠì—ˆìŠµë‹ˆë‹¤.`, "status-disconnected");
                appendSystemMessage(`âŒ ì†¡ì‹ ìê°€ ë°©ì„ ë– ë‚¬ìŠµë‹ˆë‹¤. ìŠ¤íŠ¸ë¦¼ ì¢…ë£Œ.`);
                remoteVideo.srcObject = null;
                disableInteractionButtons();
                if (pc) {
                    pc.close();
                    pc = null;
                }
            }
            break;
          case "room-members":
            if (data.roomId === currentRoomId) {
                updateViewerList(data.members);
            }
            break;
          default:
            console.warn("âš ï¸ ì•Œ ìˆ˜ ì—†ëŠ” ë©”ì‹œì§€ íƒ€ì…:", data.type);
        }
      } catch (error) {
        console.error("âŒ ë©”ì‹œì§€ ì²˜ë¦¬ ì˜¤ë¥˜:", error);
      }
    };

    // ë°© ì…ì¥ ì²˜ë¦¬
    enterRoomBtn.addEventListener("click", () => {
        if (!isWsConnected) {
            alert("ë¨¼ì € ì‹œê·¸ë„ë§ ì„œë²„ì— ì—°ê²°ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.");
            return;
        }
        const newRoomId = roomIdInput.value.trim();
        if (!newRoomId) {
            alert("ì…ì¥í•  ë°© IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        if (hasEnteredRoom && newRoomId === currentRoomId) {
            alert(`ì´ë¯¸ "${newRoomId}" ë°©ì— ì…ì¥í•´ ìˆìŠµë‹ˆë‹¤.`);
            return;
        }

        // ê¸°ì¡´ ë°©ì—ì„œ ë‚˜ê°€ëŠ” ì²˜ë¦¬ (ì„ íƒì ìœ¼ë¡œ êµ¬í˜„)
        if (pc) {
            pc.close();
            pc = null;
            remoteVideo.srcObject = null;
            console.log("ê¸°ì¡´ PeerConnection ì¢…ë£Œ");
        }
        
        currentRoomId = newRoomId;
        displayRoomId.textContent = currentRoomId;
        hasEnteredRoom = true;
        iceCandidateQueue = []; // ë°© ë³€ê²½ ì‹œ ICE í ì´ˆê¸°í™”

        ws.send(JSON.stringify({
            type: "enterRoom",
            role: "viewer",
            viewerId: viewerId,
            roomId: currentRoomId
        }));
        
        updateStatus(`ë°© "${currentRoomId}"ì— ì…ì¥ ìš”ì²­ ì¤‘...`, "status-waiting");
        appendSystemMessage(`ğŸ‰ ë°© "${currentRoomId}"ì— ì…ì¥í–ˆìŠµë‹ˆë‹¤.`);
        console.log(`âœ… ë°© ì…ì¥ ìš”ì²­: ${currentRoomId}`);
        sendBtn.disabled = false; // ë°©ì— ì…ì¥í•˜ë©´ ì±„íŒ… ê°€ëŠ¥
    });

    // ë°© ID ì…ë ¥ì°½ì—ì„œ Enter í‚¤
    roomIdInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
            e.preventDefault();
            enterRoomBtn.click();
        }
    });


    // Offer ì²˜ë¦¬
    async function handleOffer(data) {
      console.log("ğŸ“¨ Offer ìˆ˜ì‹ ");
      
      // ê¸°ì¡´ PeerConnectionì´ ìˆë‹¤ë©´ ì •ë¦¬
      if (pc) {
        pc.close();
        pc = null;
        console.log("ê¸°ì¡´ PeerConnection ì •ë¦¬ ì™„ë£Œ.");
      }

      pc = new RTCPeerConnection({
        iceServers: [
          { urls: "stun:stun.l.google.com:19302" },
          { urls: "stun:stun1.l.google.com:19302" }
        ]
      });

      pc.ontrack = (event) => {
        console.log("ğŸ¥ ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ ìˆ˜ì‹ ");
        if (remoteVideo.srcObject !== event.streams[0]) {
            remoteVideo.srcObject = event.streams[0];
            updateStatus("ì˜ìƒ ìŠ¤íŠ¸ë¦¼ ì—°ê²°ë¨", "status-connected");
            enableInteractionButtons(); // ìŠ¤íŠ¸ë¦¼ ìˆ˜ì‹  ì‹œ ì¢‹ì•„ìš”/ë³„í’ì„ /ì±„íŒ… í™œì„±í™”
        }
      };

      pc.onicecandidate = (event) => {
        if (event.candidate && hasEnteredRoom && currentRoomId) { // ë°©ì— ì…ì¥í•œ ìƒíƒœì—ì„œë§Œ ì „ì†¡
          ws.send(JSON.stringify({
            type: "candidate",
            from: viewerId,
            to: data.from, // offerë¥¼ ë³´ë‚¸ ì†¡ì‹ ìì—ê²Œ ë‹¤ì‹œ ë³´ëƒ„
            candidate: event.candidate,
            roomId: currentRoomId // ë°© ID í¬í•¨
          }));
        }
      };

      pc.onconnectionstatechange = () => {
        console.log(`ğŸ”— ì—°ê²° ìƒíƒœ: ${pc.connectionState}`);
        if (pc.connectionState === "connected") {
          updateStatus("ì—°ê²° ì™„ë£Œ", "status-connected");
          enableInteractionButtons();
        } else if (pc.connectionState === "disconnected" || pc.connectionState === "failed" || pc.connectionState === "closed") {
          updateStatus("ìŠ¤íŠ¸ë¦¼ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ì†¡ì‹ ì ì¬ì ‘ì† ëŒ€ê¸° ì¤‘...", "status-disconnected");
          disableInteractionButtons();
          remoteVideo.srcObject = null;
          if (pc) {
            pc.close();
            pc = null;
          }
          appendSystemMessage("ìŠ¤íŠ¸ë¦¼ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ì†¡ì‹ ì ëŒ€ê¸° ì¤‘...");
        }
      };

      pc.oniceconnectionstatechange = () => {
        console.log(`ğŸ§Š ICE ìƒíƒœ: ${pc.iceConnectionState}`);
      };

      // ë°ì´í„° ì±„ë„ ì„¤ì • (ì†¡ì‹ ìë¡œë¶€í„° ì—´ë¦´ ì±„ë„ì„ ë°›ìŒ)
      pc.ondatachannel = (event) => {
        const dataChannel = event.channel;
        console.log(`âœ… ë°ì´í„° ì±„ë„ ìˆ˜ì‹ ë¨: ${dataChannel.label}`);
        dataChannel.onopen = () => {
            console.log("ë°ì´í„° ì±„ë„ ì—´ë¦¼ (ìˆ˜ì‹ ì)");
            // dataChannel.send("Hello from viewer!"); // í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€
        };
        dataChannel.onmessage = (e) => {
            console.log("ë°ì´í„° ì±„ë„ ë©”ì‹œì§€ ìˆ˜ì‹ :", e.data);
            // ì´ê³³ì—ì„œ ë°ì´í„° ì±„ë„ ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        };
        dataChannel.onclose = () => console.log("ë°ì´í„° ì±„ë„ ë‹«í˜ (ìˆ˜ì‹ ì)");
        dataChannel.onerror = (error) => console.error("ë°ì´í„° ì±„ë„ ì˜¤ë¥˜ (ìˆ˜ì‹ ì):", error);
      };

      try {
        await pc.setRemoteDescription(data.sdp);
        console.log("âœ… Remote Description ì„¤ì • ì™„ë£Œ");
        
        // íì— ìˆë˜ ICE candidateë“¤ ì¶”ê°€
        for (const candidate of iceCandidateQueue) {
          try {
            await pc.addIceCandidate(candidate);
            console.log("âœ… íì— ìˆë˜ ICE Candidate ì¶”ê°€");
          } catch (e) {
            console.warn("âš ï¸ íì— ìˆë˜ ICE Candidate ì¶”ê°€ ì‹¤íŒ¨:", e);
          }
        }
        iceCandidateQueue = []; // í ë¹„ìš°ê¸°

        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        ws.send(JSON.stringify({
          type: "answer",
          from: viewerId,
          to: data.from, // answerë¥¼ ë°›ì„ ëŒ€ìƒì€ offerë¥¼ ë³´ë‚¸ ì†¡ì‹ ì
          sdp: answer,
          roomId: currentRoomId // ë°© ID í¬í•¨
        }));

        console.log("ğŸ“¤ Answer ì „ì†¡ ì™„ë£Œ");
        updateStatus("ì—°ê²° ì„¤ì • ì¤‘...", "status-waiting");
      } catch (error) {
        console.error("âŒ Offer ì²˜ë¦¬ ì‹¤íŒ¨:", error);
        updateStatus("ì—°ê²° ì„¤ì • ì‹¤íŒ¨", "status-disconnected");
        disableInteractionButtons();
      }
    }

    // ICE Candidate ì²˜ë¦¬
    async function handleCandidate(data) {
      if (!pc || !pc.remoteDescription || !pc.remoteDescription.type) {
        console.log("ğŸ§Š ICE Candidate íì— ì €ì¥");
        iceCandidateQueue.push(data.candidate);
        return;
      }

      try {
        await pc.addIceCandidate(data.candidate);
        console.log("âœ… ICE Candidate ì¶”ê°€");
      } catch (error) {
        console.warn("âš ï¸ ICE Candidate ì¶”ê°€ ì‹¤íŒ¨:", error);
      }
    }

    // ì¢‹ì•„ìš” ì—…ë°ì´íŠ¸ ì²˜ë¦¬
    function handleLikeUpdate(data) {
      appendSystemMessage(`â¤ï¸ ì¢‹ì•„ìš”! (${data.from}ë‹˜ì´ ëˆŒë €ìŠµë‹ˆë‹¤)`);
    }

    // ë³„í’ì„  ì²˜ë¦¬
    function handleStarBalloon(data) {
      const effectDiv = document.createElement("div");
      effectDiv.className = "effect-message";
      effectDiv.innerHTML = `â­ ${escapeHtml(data.from)}ë‹˜ì´ ë³„í’ì„  ${data.count}ê°œë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤! â­`;
      
      chatLog.appendChild(effectDiv);
      chatLog.scrollTop = chatLog.scrollHeight;
      
      // 3ì´ˆ í›„ ì¼ë°˜ ë©”ì‹œì§€ë¡œ ë³€ê²½
      setTimeout(() => {
        // ì›ë˜ì˜ chat-message ìŠ¤íƒ€ì¼ë¡œ ë˜ëŒë¦´ í•„ìš”ê°€ ìˆë‹¤ë©´ ì—¬ê¸°ì— ì¶”ê°€
        // í˜„ì¬ëŠ” effect-message í´ë˜ìŠ¤ë¥¼ ìœ ì§€í•˜ë©° ìŠ¤íƒ€ì¼ë§Œ ë³€ê²½
        effectDiv.style.background = "#e9ecef";
        effectDiv.style.border = "none";
        effectDiv.style.animation = "none";
        effectDiv.style.boxShadow = "none";
        effectDiv.style.color = "#333";
        effectDiv.style.textAlign = "left";
      }, 3000);
    }

    // ë‹‰ë„¤ì„ ë³€ê²½ ì²˜ë¦¬
    function handleNicknameChange(data) {
      appendSystemMessage(`ğŸ“ ${escapeHtml(data.oldNickname)}ë‹˜ì´ ë‹‰ë„¤ì„ì„ "${escapeHtml(data.newNickname)}"ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤`);
    }

    // ì±„íŒ… ë©”ì‹œì§€ ì¶”ê°€
    function appendChatMessage(sender, message) {
      const div = document.createElement("div");
      div.className = "chat-message";
      div.innerHTML = `<strong>${escapeHtml(sender)}:</strong> ${escapeHtml(message)}`;
      chatLog.appendChild(div);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    // ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì¶”ê°€
    function appendSystemMessage(message) {
      const div = document.createElement("div");
      div.className = "system-message";
      div.innerHTML = escapeHtml(message);
      chatLog.appendChild(div);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    // ë‹‰ë„¤ì„ ë³€ê²½
    function changeNickname() {
      const newNickname = nicknameInput.value.trim();
      if (!newNickname) {
        alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
      if (newNickname === currentNickname) {
        return;
      }

      const oldNickname = currentNickname;
      currentNickname = newNickname;

      if (hasEnteredRoom && isWsConnected) {
        ws.send(JSON.stringify({
          type: "nickname-change",
          from: viewerId, // ì‹¤ì œ ì†¡ì‹ ìëŠ” viewerId
          oldNickname: oldNickname,
          newNickname: newNickname,
          roomId: currentRoomId // ë°© ID í¬í•¨
        }));
      }

      appendSystemMessage(`ğŸ“ ë‹‰ë„¤ì„ì„ "${escapeHtml(newNickname)}"ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤`);
    }

    // ì¢‹ì•„ìš” ì „ì†¡
    function sendLike() {
      if (!isWsConnected || !hasEnteredRoom) return;

      ws.send(JSON.stringify({
        type: "like",
        from: currentNickname,
        viewerId: viewerId,
        roomId: currentRoomId // ë°© ID í¬í•¨
      }));

      // ë³¸ì¸ ì±„íŒ…ì°½ì— ì¦‰ì‹œ í‘œì‹œ
      appendSystemMessage(`â¤ï¸ ë‚´ê°€ ì¢‹ì•„ìš”ë¥¼ ëˆŒë €ìŠµë‹ˆë‹¤!`);

      // ë²„íŠ¼ ì• ë‹ˆë©”ì´ì…˜
      likeBtn.style.transform = "scale(1.2)";
      setTimeout(() => {
        likeBtn.style.transform = "scale(1)";
      }, 200);
    }

    // ë³„í’ì„  ì „ì†¡
    function sendStarBalloon() {
      if (!isWsConnected || !hasEnteredRoom) return;

      const count = parseInt(starBalloonInput.value);
      if (isNaN(count) || count < 1 || count > 100000) {
        alert("ë³„í’ì„ ì€ 1ê°œë¶€í„° 100000ê°œê¹Œì§€ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        return;
      }

      ws.send(JSON.stringify({
        type: "star-balloon",
        from: currentNickname,
        count: count,
        viewerId: viewerId,
        roomId: currentRoomId // ë°© ID í¬í•¨
      }));

      // ë³¸ì¸ ì±„íŒ…ì°½ì— ì¦‰ì‹œ í‘œì‹œ
      appendSystemMessage(`â­ ë‚´ê°€ ë³„í’ì„  ${count}ê°œë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤!`);

      // ë²„íŠ¼ ì• ë‹ˆë©”ì´ì…˜
      starBalloonBtn.style.transform = "scale(1.2)";
      setTimeout(() => {
        starBalloonBtn.style.transform = "scale(1)";
      }, 200);
    }

    // ì±„íŒ… ì „ì†¡
    function sendChat() {
      const message = chatInput.value.trim();
      if (!message || !isWsConnected || !hasEnteredRoom) return;

      ws.send(JSON.stringify({ 
        type: "chat", 
        from: currentNickname, // ì±„íŒ… ë³´ë‚¼ ë•Œ ë‹‰ë„¤ì„ ì‚¬ìš©
        message: message,
        roomId: currentRoomId // ë°© ID í¬í•¨
      }));
      
      appendChatMessage("ë‚˜", message);
      chatInput.value = "";
    }

    // ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateStatus(message, type) {
      status.textContent = message;
      status.className = `status ${type}`;
    }

    // ìƒí˜¸ì‘ìš© ë²„íŠ¼ í™œì„±í™”
    function enableInteractionButtons() {
        sendBtn.disabled = false;
        likeBtn.disabled = false;
        starBalloonBtn.disabled = false;
    }

    // ìƒí˜¸ì‘ìš© ë²„íŠ¼ ë¹„í™œì„±í™”
    function disableInteractionButtons() {
        sendBtn.disabled = true;
        likeBtn.disabled = true;
        starBalloonBtn.disabled = true;
    }

    // HTML ì´ìŠ¤ì¼€ì´í”„
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ì ‘ì† ì¤‘ì¸ ë·°ì–´ ëª©ë¡ ì—…ë°ì´íŠ¸
    function updateViewerList(members) {
        activeViewersList.innerHTML = '';
        viewerCountDisplay.textContent = members.length;
        if (members.length === 0) {
            const li = document.createElement("li");
            li.textContent = "ì•„ì§ ì ‘ì† ì¤‘ì¸ ì‹œì²­ìê°€ ì—†ìŠµë‹ˆë‹¤.";
            activeViewersList.appendChild(li);
        } else {
            members.forEach(memberId => {
                const li = document.createElement("li");
                li.textContent = (memberId === viewerId) ? `${currentNickname} (ë‚˜)` : memberId; // ë‚´ ë‹‰ë„¤ì„ í‘œì‹œ
                activeViewersList.appendChild(li);
            });
        }
    }


    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    changeNicknameBtn.addEventListener("click", changeNickname);
    nicknameInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        changeNickname();
      }
    });

    likeBtn.addEventListener("click", sendLike);
    starBalloonBtn.addEventListener("click", sendStarBalloon);
    
    starBalloonInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        sendStarBalloon();
      }
    });

    sendBtn.addEventListener("click", sendChat);
    chatInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        sendChat();
      }
    });

    // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì •ë¦¬
    window.addEventListener("beforeunload", () => {
      if (pc) {
        pc.close();
      }
      ws.close();
    });

    // ì´ˆê¸° ìƒíƒœ ì„¤ì •
    disableInteractionButtons(); // ì´ˆê¸°ì—ëŠ” ëª¨ë“  ìƒí˜¸ì‘ìš© ë²„íŠ¼ ë¹„í™œì„±í™”
    enterRoomBtn.disabled = true; // WebSocket ì—°ê²° ì „ê¹Œì§€ ë°© ì…ì¥ ë²„íŠ¼ ë¹„í™œì„±í™”
    displayRoomId.textContent = "ì„ íƒ ì•ˆë¨"; // ì´ˆê¸° ë°© ID í‘œì‹œ
    updateViewerList([]); // ì´ˆê¸° ë·°ì–´ ëª©ë¡ ë¹„ìš°ê¸°
  </script>
</body>
</html>