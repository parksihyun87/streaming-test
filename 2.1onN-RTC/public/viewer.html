<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ‘ï¸ ìˆ˜ì‹ ì í™”ë©´</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    video {
      width: 100%;
      max-width: 640px;
      height: auto;
      border: 2px solid #333;
      border-radius: 8px;
      margin-bottom: 20px;
      background-color: #000;
    }
    
    #chatContainer {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      background-color: #f9f9f9;
    }
    
    #chatLog {
      height: 200px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 10px;
      background-color: white;
      border-radius: 4px;
      margin-bottom: 10px;
      font-size: 14px;
    }
    
    #chatInputContainer {
      display: flex;
      gap: 10px;
    }
    
    #chatInput {
      flex: 1;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }
    
    #sendBtn {
      padding: 8px 16px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    #sendBtn:hover {
      background-color: #218838;
    }
    
    #sendBtn:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }
    
    #status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
      font-weight: bold;
    }
    
    .status-connected {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status-disconnected {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .status-waiting {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
  </style>
</head>
<body>
  <h1>ğŸ‘ï¸ ìˆ˜ì‹ ì í™”ë©´</h1>
  <video id="remoteVideo" autoplay playsinline controls></video>
  
  <div id="chatContainer">
    <h3>ğŸ’¬ ì±„íŒ…</h3>
    <div id="chatLog"></div>
    <div id="chatInputContainer">
      <input type="text" id="chatInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off" />
      <button id="sendBtn">ì „ì†¡</button>
    </div>
  </div>
  
  <div id="status" class="status-disconnected">ì—°ê²° ì¤‘...</div>

  <script>
    const viewerId = Math.random().toString(36).substr(2, 9);
    const ws = new WebSocket("ws://192.168.0.37:8080");
    const remoteVideo = document.getElementById("remoteVideo");
    const chatInput = document.getElementById("chatInput");
    const chatLog = document.getElementById("chatLog");
    const sendBtn = document.getElementById("sendBtn");
    const status = document.getElementById("status");

    let pc = null;
    let isConnected = false;

    // WebSocket ì—°ê²° ì²˜ë¦¬
    ws.onopen = () => {
      console.log(`ğŸ”— WebSocket ì—°ê²°ë¨ (ID: ${viewerId})`);
      ws.send(JSON.stringify({ role: "viewer", viewerId: viewerId }));
      updateStatus("ì„œë²„ì— ì—°ê²°ë¨, ì†¡ì‹ ì ëŒ€ê¸° ì¤‘...", "waiting");
    };

    ws.onclose = () => {
      console.log("âŒ WebSocket ì—°ê²° ì¢…ë£Œ");
      updateStatus("ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤", "disconnected");
      isConnected = false;
      sendBtn.disabled = true;
    };

    ws.onerror = (error) => {
      console.error("ğŸš¨ WebSocket ì˜¤ë¥˜:", error);
      updateStatus("ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤", "disconnected");
    };

    ws.onmessage = async (event) => {
      try {
        const data = JSON.parse(event.data);
        console.log("ğŸ“¨ ë©”ì‹œì§€ ìˆ˜ì‹ :", data);

        switch (data.type) {
          case "offer":
            await handleOffer(data);
            break;
          case "candidate":
            await handleCandidate(data);
            break;
          case "chat":
            appendChatMessage(data.from, data.message);
            break;
          default:
            console.warn("âš ï¸ ì•Œ ìˆ˜ ì—†ëŠ” ë©”ì‹œì§€ íƒ€ì…:", data.type);
        }
      } catch (error) {
        console.error("âŒ ë©”ì‹œì§€ ì²˜ë¦¬ ì˜¤ë¥˜:", error);
      }
    };

    // Offer ì²˜ë¦¬
    async function handleOffer(data) {
      console.log("ğŸ“¨ Offer ìˆ˜ì‹ ");
      
      // ê¸°ì¡´ ì—°ê²°ì´ ìˆë‹¤ë©´ ì •ë¦¬
      if (pc) {
        pc.close();
        pc = null;
      }

      // ìƒˆ PeerConnection ìƒì„±
      pc = new RTCPeerConnection({
        iceServers: [
          { urls: "stun:stun.l.google.com:19302" },
          { urls: "stun:stun1.l.google.com:19302" }
        ]
      });

      // ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ ìˆ˜ì‹  ì²˜ë¦¬
      pc.ontrack = (event) => {
        console.log("ğŸ¥ ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ ìˆ˜ì‹ ");
        remoteVideo.srcObject = event.streams[0];
        updateStatus("ì˜ìƒ ìŠ¤íŠ¸ë¦¼ ì—°ê²°ë¨", "connected");
        isConnected = true;
        sendBtn.disabled = false;
      };

      // ICE Candidate ì²˜ë¦¬
      pc.onicecandidate = (event) => {
        if (event.candidate) {
          ws.send(JSON.stringify({
            type: "candidate",
            from: viewerId,
            to: data.from,
            candidate: event.candidate
          }));
        }
      };

      // ì—°ê²° ìƒíƒœ ëª¨ë‹ˆí„°ë§
      pc.onconnectionstatechange = () => {
        console.log(`ğŸ”— ì—°ê²° ìƒíƒœ: ${pc.connectionState}`);
        if (pc.connectionState === "connected") {
          updateStatus("ì—°ê²° ì™„ë£Œ", "connected");
        } else if (pc.connectionState === "disconnected" || pc.connectionState === "failed") {
          updateStatus("ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤", "disconnected");
          isConnected = false;
          sendBtn.disabled = true;
        }
      };

      pc.oniceconnectionstatechange = () => {
        console.log(`ğŸ§Š ICE ìƒíƒœ: ${pc.iceConnectionState}`);
      };

      try {
        // Remote Description ì„¤ì •
        await pc.setRemoteDescription(data.sdp);
        
        // Answer ìƒì„±
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        // Answer ì „ì†¡
        ws.send(JSON.stringify({
          type: "answer",
          from: viewerId,
          to: data.from,
          sdp: answer
        }));

        console.log("ğŸ“¤ Answer ì „ì†¡ ì™„ë£Œ");
        updateStatus("ì—°ê²° ì„¤ì • ì¤‘...", "waiting");
      } catch (error) {
        console.error("âŒ Offer ì²˜ë¦¬ ì‹¤íŒ¨:", error);
        updateStatus("ì—°ê²° ì„¤ì • ì‹¤íŒ¨", "disconnected");
      }
    }

    // ICE Candidate ì²˜ë¦¬
    async function handleCandidate(data) {
      if (!pc) {
        console.warn("âš ï¸ PeerConnectionì´ ì—†ìŠµë‹ˆë‹¤");
        return;
      }

      try {
        await pc.addIceCandidate(data.candidate);
        console.log("âœ… ICE Candidate ì¶”ê°€");
      } catch (error) {
        console.warn("âš ï¸ ICE Candidate ì¶”ê°€ ì‹¤íŒ¨:", error);
      }
    }

    // ì±„íŒ… ë©”ì‹œì§€ ì¶”ê°€
    function appendChatMessage(sender, message) {
      const div = document.createElement("div");
      div.style.marginBottom = "5px";
      div.innerHTML = `<strong>${escapeHtml(sender)}:</strong> ${escapeHtml(message)}`;
      chatLog.appendChild(div);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    // ì±„íŒ… ì „ì†¡
    function sendChat() {
      const message = chatInput.value.trim();
      if (!message || !isConnected) return;

      ws.send(JSON.stringify({ 
        type: "chat", 
        from: viewerId, 
        message: message 
      }));
      
      appendChatMessage("ë‚˜", message);
      chatInput.value = "";
    }

    // ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateStatus(message, type) {
      status.textContent = message;
      status.className = `status-${type}`;
    }

    // HTML ì´ìŠ¤ì¼€ì´í”„
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    sendBtn.addEventListener("click", sendChat);
    chatInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        sendChat();
      }
    });

    // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì •ë¦¬
    window.addEventListener("beforeunload", () => {
      if (pc) {
        pc.close();
      }
      ws.close();
    });

    // ì´ˆê¸° ìƒíƒœ ì„¤ì •
    sendBtn.disabled = true;
  </script>
</body>
</html>