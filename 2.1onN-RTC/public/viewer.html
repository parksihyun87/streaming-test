<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ÏàòÏã†Ïûê ÌôîÎ©¥</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      color: #333;
    }

    h1 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 25px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }

    .section-container {
      background-color: #ffffff;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
      padding: 25px;
      margin-bottom: 25px;
      width: 100%;
      max-width: 800px;
      box-sizing: border-box;
    }

    .section-container h3 {
      color: #34495e;
      border-bottom: 2px solid #ecf0f1;
      padding-bottom: 12px;
      margin-top: 0;
      margin-bottom: 20px;
      text-align: center;
    }

    video {
      max-width: 800px;
      width: 100%;
      height: auto;
      border: 4px solid #2c3e50;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.25);
      background: #000;
      margin-bottom: 25px;
      display: block; /* Ensures video is a block element for margin auto */
    }

    .input-group {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      align-items: center;
      flex-wrap: wrap;
    }

    .input-group label {
      font-weight: bold;
      color: #555;
      white-space: nowrap;
    }

    .input-group input[type="text"], .input-group input[type="number"] {
      flex: 1;
      padding: 10px 15px;
      border: 1px solid #ced4da;
      border-radius: 8px;
      font-size: 16px;
      min-width: 120px;
    }

    .input-group button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background: #007bff;
      color: white;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.3s ease, transform 0.2s ease;
    }

    .input-group button:hover {
      background: #0056b3;
      transform: translateY(-1px);
    }

    .input-group button:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }

    .action-buttons {
      display: flex;
      gap: 15px;
      margin: 20px 0;
      flex-wrap: wrap;
      justify-content: center;
    }

    .like-btn, .star-balloon-btn, .fan-membership-btn { /* Add fan-membership-btn */
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 30px;
      font-size: 17px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: bold;
    }

    .like-btn {
      background: linear-gradient(45deg, #ff6b6b, #ff5252);
    }
    .like-btn:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
    }

    .star-balloon-btn {
      background: linear-gradient(45deg, #ffd700, #ffb300);
    }
    .star-balloon-btn:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
    }

    .fan-membership-btn { /* Style for fan membership button */
      background: linear-gradient(45deg, #a855f7, #9333ea); /* Purple gradient */
    }
    .fan-membership-btn:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 6px 20px rgba(168, 85, 247, 0.4);
    }

    .star-balloon-btn:disabled, .like-btn:disabled, .fan-membership-btn:disabled { /* Disable style for fan button */
      background: #cccccc;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    #chatLog {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 15px;
      height: 250px;
      overflow-y: auto;
      color: #333;
      font-size: 15px;
      line-height: 1.6;
      border: 1px solid #e0e6ed;
    }

    .chat-message {
      margin-bottom: 8px;
      padding: 8px 12px;
      border-radius: 8px;
      background: #e9ecef;
      word-wrap: break-word;
    }
    .chat-message strong {
        color: #007bff;
    }
    .chat-message.fan strong { /* Style for fan's nickname in chat */
        color: #9333ea; /* Purple for fan */
    }

    .system-message {
      color: #6c757d;
      font-style: italic;
      text-align: center;
      margin: 10px 0;
      font-size: 14px;
      padding: 5px;
      border-radius: 5px;
      background: #e2e6ea;
    }
    .effect-message {
      background: linear-gradient(90deg, #ffedd5, #fef3c7);
      color: #8a6d3b;
      padding: 12px 18px;
      border-radius: 10px;
      margin: 8px 0;
      font-weight: bold;
      border: 2px solid #fce891;
      box-shadow: 0 4px 15px rgba(255, 215, 0, 0.5);
      animation: sparkle 1s ease-in-out;
      text-align: center;
    }

    @keyframes sparkle {
      0% { transform: scale(0.8); opacity: 0; }
      50% { transform: scale(1.1); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }

    #chatInputContainer {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    #chatInput {
      flex: 1;
      padding: 10px 15px;
      border: 1px solid #ced4da;
      border-radius: 8px;
      background: #f8f9fa;
      color: #333;
      font-size: 16px;
    }

    #sendBtn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background: #2196F3;
      color: white;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.3s ease;
    }
    #sendBtn:hover {
      background: #1976D2;
    }
    #sendBtn:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }

    #status {
      margin-top: 25px;
      padding: 15px;
      border-radius: 10px;
      font-weight: bold;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      transition: background-color 0.3s ease, color 0.3s ease;
      width: 100%;
      max-width: 800px;
    }

    .status-connected {
      background: #e6ffed;
      color: #1a7e3d;
      border: 1px solid #a3e0c0;
    }

    .status-disconnected {
      background: #ffe6e6;
      color: #c93b3b;
      border: 1px solid #f2a7a7;
    }

    .status-waiting {
      background: #fff3e0;
      color: #e67e22;
      border: 1px solid #ffd591;
    }

    #viewerList {
      background-color: #e9ecef;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
    }
    #viewerList ul {
      list-style: none;
      padding: 0;
      max-height: 100px;
      overflow-y: auto;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      background-color: #f8f9fa;
      padding: 10px;
    }
    #viewerList li {
      padding: 5px 0;
      border-bottom: 1px dashed #ced4da;
      font-size: 14px;
      color: #495057;
    }
    #viewerList li:last-child {
      border-bottom: none;
    }
    .viewer-item.fan { /* Style for fan in viewer list */
        font-weight: bold;
        color: #9333ea;
    }
  </style>
</head>
<body>
  <h1>üëÅÔ∏è ÏàòÏã†Ïûê ÌôîÎ©¥</h1>
  
  <div class="section-container">
    <h3>üö™ Î∞© ÏûÖÏû• ÏÑ§Ï†ï</h3>
    <div class="input-group">
      <label for="roomIdInput">Î∞© ID:</label>
      <input type="text" id="roomIdInput" placeholder="ÏûÖÏû•Ìï† Î∞© IDÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" value="defaultRoom" />
      <button id="enterRoomBtn">Î∞© ÏûÖÏû•</button>
    </div>
    <div class="input-group">
      <label for="nicknameInput">ÎãâÎÑ§ÏûÑ:</label>
      <input type="text" id="nicknameInput" placeholder="ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" value="ÏùµÎ™Ö" />
      <button id="changeNicknameBtn">Î≥ÄÍ≤Ω</button>
    </div>
    <div id="currentRoomDisplay" style="text-align: center; margin-top: 10px; font-weight: bold; color: #555;">
      ÌòÑÏû¨ Î∞©: <span id="displayRoomId">ÏÑ†ÌÉù ÏïàÎê®</span>
    </div>
  </div>

  <video id="remoteVideo" autoplay playsinline controls></video>
  
  <div class="action-buttons">
    <button id="likeBtn" class="like-btn" disabled>‚ù§Ô∏è Ï¢ãÏïÑÏöî</button>
    <div class="input-group">
      <label>Î≥ÑÌíçÏÑ†:</label>
      <input type="number" id="starBalloonInput" class="star-balloon-input" min="1" max="100000" value="1" />
      <button id="starBalloonBtn" class="star-balloon-btn" disabled>‚≠ê Î≥¥ÎÇ¥Í∏∞</button>
    </div>
    <button id="fanMembershipBtn" class="fan-membership-btn" disabled>üíú Ìå¨ Í∞ÄÏûÖ</button> </div>
  
  <div class="section-container">
    <h3>üí¨ Ï±ÑÌåÖ</h3>
    <div id="chatLog"></div>
    <div id="chatInputContainer">
      <input type="text" id="chatInput" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." autocomplete="off" />
      <button id="sendBtn" disabled>Ï†ÑÏÜ°</button>
    </div>
  </div>

  <div class="section-container">
    <h3>üë• Ï†ëÏÜç Ï§ëÏù∏ ÏãúÏ≤≠Ïûê (<span id="viewerCount">0</span>Î™Ö)</h3>
    <div id="viewerList">
      <ul id="activeViewers">
        </ul>
    </div>
  </div>
  
  <div id="status" class="status-disconnected">Ïó∞Í≤∞ Ï§ë...</div>

  <script>
    const viewerId = Math.random().toString(36).substr(2, 9); // Í≥†Ïú†Ìïú ÏàòÏã†Ïûê ID
    // const ws = new WebSocket("ws://192.168.0.238:8080");
    const ws = new WebSocket("ws://localhost:8080");
    const remoteVideo = document.getElementById("remoteVideo");
    const chatInput = document.getElementById("chatInput");
    const chatLog = document.getElementById("chatLog");
    const sendBtn = document.getElementById("sendBtn");
    const status = document.getElementById("status");
    const nicknameInput = document.getElementById("nicknameInput");
    const changeNicknameBtn = document.getElementById("changeNicknameBtn");
    const likeBtn = document.getElementById("likeBtn");
    const starBalloonBtn = document.getElementById("starBalloonBtn");
    const starBalloonInput = document.getElementById("starBalloonInput");
    const roomIdInput = document.getElementById("roomIdInput");
    const enterRoomBtn = document.getElementById("enterRoomBtn");
    const displayRoomId = document.getElementById("displayRoomId");
    const activeViewersList = document.getElementById("activeViewers");
    const viewerCountDisplay = document.getElementById("viewerCount");
    const fanMembershipBtn = document.getElementById("fanMembershipBtn"); // New Fan Membership Button

    let pc = null;
    let iceCandidateQueue = [];
    let isWsConnected = false;
    let hasEnteredRoom = false; // Î∞© ÏûÖÏû• Ïó¨Î∂Ä
    let currentNickname = localStorage.getItem('viewerNickname') || "ÏùµÎ™Ö"; // Load nickname from localStorage
    let currentRoomId = null; // ÌòÑÏû¨ ÏûÖÏû•Ìïú Î∞© ID
    let isFan = localStorage.getItem(`isFan_${viewerId}`) === 'true'; // Load fan status from localStorage

    // Ï¥àÍ∏∞ ÎãâÎÑ§ÏûÑ ÏÑ§Ï†ï
    nicknameInput.value = currentNickname;
    updateFanMembershipButtonText(); // Update button text based on initial fan status

    // WebSocket Ïó∞Í≤∞ Ï≤òÎ¶¨
    ws.onopen = () => {
      console.log(`üîó WebSocket Ïó∞Í≤∞Îê® (ID: ${viewerId})`);
      isWsConnected = true;
      updateStatus("ÏãúÍ∑∏ÎÑêÎßÅ ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Îê®. Î∞©Ïóê ÏûÖÏû•Ìï¥Ï£ºÏÑ∏Ïöî.", "status-waiting");
      enterRoomBtn.disabled = false; // Ïó∞Í≤∞ÎêòÎ©¥ Î∞© ÏûÖÏû• Î≤ÑÌäº ÌôúÏÑ±Ìôî
    };

    ws.onclose = () => {
      console.log("‚ùå WebSocket Ïó∞Í≤∞ Ï¢ÖÎ£å");
      isWsConnected = false;
      hasEnteredRoom = false;
      updateStatus("Ïó∞Í≤∞Ïù¥ ÎÅäÏñ¥Ï°åÏäµÎãàÎã§.", "status-disconnected");
      disableInteractionButtons();
      if (pc) {
        pc.close();
        pc = null;
      }
      remoteVideo.srcObject = null; // ÎπÑÎîîÏò§ Ïä§Ìä∏Î¶º Ìï¥Ï†ú
      appendSystemMessage("ÏÑúÎ≤ÑÏôÄÏùò Ïó∞Í≤∞Ïù¥ ÎÅäÏñ¥Ï°åÏäµÎãàÎã§.");
      displayRoomId.textContent = "Ïó∞Í≤∞ ÎÅäÍπÄ";
      updateViewerList([]);
    };

    ws.onerror = (event) => {
      console.error("üö® WebSocket Ïò§Î•ò:", event);
      if (event && event.target && event.target.readyState === WebSocket.CLOSED) {
        console.error("ÏõπÏÜåÏºìÏù¥ Îã´Ìûå ÏÉÅÌÉúÏóêÏÑú Ïò§Î•ò Î∞úÏÉù:", event.target.url);
      }
    };

    ws.onmessage = async (event) => {
      try {
        const data = JSON.parse(event.data);
        console.log("üì® Î©îÏãúÏßÄ ÏàòÏã†:", data);

        switch (data.type) {
          case "offer":
            if (data.roomId === currentRoomId) { // ÌòÑÏû¨ Î∞©Ïùò offerÎßå Ï≤òÎ¶¨
              await handleOffer(data);
              appendSystemMessage(`üé• ÏÜ°Ïã†ÏûêÍ∞Ä Ïä§Ìä∏Î¶¨Î∞çÏùÑ ÏãúÏûëÌñàÏäµÎãàÎã§.`);
            } else {
              console.warn(`Îã§Î•∏ Î∞©(${data.roomId})Ïùò offer ÏàòÏã†, Î¨¥ÏãúÌï®.`);
            }
            break;
          case "candidate":
            if (data.roomId === currentRoomId) { // ÌòÑÏû¨ Î∞©Ïùò candidateÎßå Ï≤òÎ¶¨
              await handleCandidate(data);
            }
            break;
          case "chat":
            // Pass isFan status to appendChatMessage
            appendChatMessage(data.from, data.message, data.isFan);
            break;
          case "like":
            handleLikeUpdate(data);
            break;
          case "star-balloon":
            handleStarBalloon(data);
            break;
          case "nickname-change":
            handleNicknameChange(data);
            break;
          case "sender-available":
            if (data.roomId === currentRoomId) {
              appendSystemMessage(`‚úÖ ÏÜ°Ïã†ÏûêÍ∞Ä Î∞©Ïóê Ï†ëÏÜçÌñàÏäµÎãàÎã§. Í≥ß Ïä§Ìä∏Î¶ºÏù¥ ÏãúÏûëÎê©ÎãàÎã§.`);
              // If sender becomes available, try to initiate connection
              if (!pc) {
                // If there's no existing PC, create a new one and send offer
                // This might be redundant if the server sends an offer directly after sender-available,
                // but good for robustness if initial offer is missed.
                // createPeerConnection();
              }
            }
            break;
          case "sender-unavailable":
            if (data.roomId === currentRoomId) {
              appendSystemMessage(`‚ùå ÏÜ°Ïã†ÏûêÍ∞Ä Î∞©ÏóêÏÑú ÎÇòÍ∞îÏäµÎãàÎã§. Ïä§Ìä∏Î¶ºÏù¥ Ï¢ÖÎ£åÎê©ÎãàÎã§.`);
              updateStatus(`Î∞© "${data.roomId}"Ïóê ÏÜ°Ïã†ÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§.`, "status-waiting");
              if (pc) {
                pc.close();
                pc = null;
              }
              remoteVideo.srcObject = null;
              disableInteractionButtons();
            }
            break;
          case "no-sender-available":
            if (data.roomId === currentRoomId) {
              updateStatus(`Î∞© "${data.roomId}"Ïóê ÏÜ°Ïã†ÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§.`, "status-waiting");
              appendSystemMessage(`‚ö†Ô∏è Î∞© "${data.roomId}"Ïóê ÏÜ°Ïã†ÏûêÍ∞Ä ÌòÑÏû¨ ÏóÜÏäµÎãàÎã§. ÎåÄÍ∏∞ Ï§ë...`);
            }
            break;
          case "room-members":
            // data.members now includes nickname and isFan status
            updateViewerList(data.members, data.senderNickname); // Pass senderNickname as well
            break;
          case "fan-status-update": // New: Handle fan status updates from server
            handleFanStatusUpdate(data);
            break;
          case "sender-nickname-change": // New: Handle sender nickname change
            appendSystemMessage(`üìù ÏÜ°Ïã†ÏûêÍ∞Ä ÎãâÎÑ§ÏûÑÏùÑ "${data.newNickname}"ÏúºÎ°ú Î≥ÄÍ≤ΩÌñàÏäµÎãàÎã§.`);
            break;
          default:
            console.warn("‚ö†Ô∏è Ïïå Ïàò ÏóÜÎäî Î©îÏãúÏßÄ ÌÉÄÏûÖ:", data.type);
        }
      } catch (error) {
        console.error("‚ùå Î©îÏãúÏßÄ Ï≤òÎ¶¨ Ïò§Î•ò:", error);
      }
    };

    // WebRTC Í¥ÄÎ†® Ìï®ÏàòÎì§ (Í∏∞Ï°¥ ÏΩîÎìú Ïú†ÏßÄ)
    function createPeerConnection() {
      // ... (Í∏∞Ï°¥ createPeerConnection Ìï®Ïàò ÎÇ¥Ïö©)
      if (pc) {
        console.log("Í∏∞Ï°¥ PeerConnectionÏùÑ Îã´Í≥† ÏÉàÎ°ú ÏÉùÏÑ±Ìï©ÎãàÎã§.");
        pc.close();
        pc = null;
      }
      pc = new RTCPeerConnection({
        iceServers: [
          { urls: "stun:stun.l.google.com:19302" },
          { urls: "stun:stun1.l.google.com:19302" },
        ],
      });

      pc.onicecandidate = (event) => {
        if (event.candidate) {
          console.log("ICE candidate Ï†ÑÏÜ°:", event.candidate);
          ws.send(
            JSON.stringify({
              type: "candidate",
              candidate: event.candidate,
              to: "sender",
              roomId: currentRoomId,
            })
          );
        }
      };

      pc.ontrack = (event) => {
        console.log("Ïä§Ìä∏Î¶º ÏàòÏã†:", event.streams[0]);
        if (remoteVideo.srcObject !== event.streams[0]) {
          remoteVideo.srcObject = event.streams[0];
          remoteVideo.play().catch(error => console.error("ÎπÑÎîîÏò§ Ïû¨ÏÉù Ïò§Î•ò:", error));
        }
        updateStatus("üü¢ Ïä§Ìä∏Î¶º ÏàòÏã† Ï§ë", "status-connected");
      };

      pc.oniceconnectionstatechange = () => {
        console.log("ICE Ïó∞Í≤∞ ÏÉÅÌÉú Î≥ÄÍ≤Ω:", pc.iceConnectionState);
        if (pc.iceConnectionState === "disconnected" || pc.iceConnectionState === "failed" || pc.iceConnectionState === "closed") {
          appendSystemMessage("Ïä§Ìä∏Î¶º Ïó∞Í≤∞Ïù¥ ÎÅäÏñ¥Ï°åÏäµÎãàÎã§. ÏÜ°Ïã†Ïûê Ïó∞Í≤∞ÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.");
          updateStatus("üü° Ïä§Ìä∏Î¶º Ïó∞Í≤∞ ÎÅäÍπÄ", "status-waiting");
          if (remoteVideo.srcObject) {
            remoteVideo.srcObject.getTracks().forEach(track => track.stop());
            remoteVideo.srcObject = null;
          }
        } else if (pc.iceConnectionState === "connected") {
          updateStatus("üü¢ Ïä§Ìä∏Î¶º Ïó∞Í≤∞Îê®", "status-connected");
        }
      };
      
      // Data Channel for chat, likes, etc.
      pc.ondatachannel = (event) => {
          const dataChannel = event.channel;
          console.log('Data Channel created:', dataChannel.label);

          dataChannel.onmessage = (e) => {
              const msg = JSON.parse(e.data);
              console.log('Data Channel Message:', msg);
              // Handle messages from data channel (e.g., chat, likes if sent this way)
              if (msg.type === "chat") {
                appendChatMessage(msg.from, msg.message, msg.isFan);
              } else if (msg.type === "like") {
                handleLikeUpdate(msg);
              } else if (msg.type === "star-balloon") {
                handleStarBalloon(msg);
              }
          };

          dataChannel.onopen = () => console.log('Data Channel opened!');
          dataChannel.onclose = () => console.log('Data Channel closed!');
          dataChannel.onerror = (error) => console.error('Data Channel Error:', error);
      };
    }

    async function handleOffer(data) {
      if (!pc) {
        createPeerConnection();
      }
      const remoteDesc = new RTCSessionDescription(data.offer);
      await pc.setRemoteDescription(remoteDesc);
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      ws.send(
        JSON.stringify({
          type: "answer",
          answer: pc.localDescription,
          to: data.from, // send answer back to the sender
          from: viewerId,
          roomId: currentRoomId,
          nickname: currentNickname, // Send nickname with answer
          isFan: isFan // Send fan status with answer
        })
      );
      // Process queued ICE candidates
      iceCandidateQueue.forEach(candidate => pc.addIceCandidate(candidate));
      iceCandidateQueue = [];
    }

    async function handleCandidate(data) {
      const candidate = new RTCIceCandidate(data.candidate);
      if (pc && pc.remoteDescription && pc.remoteDescription.type) {
        await pc.addIceCandidate(candidate);
      } else {
        iceCandidateQueue.push(candidate);
      }
    }

    // UI ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
    function updateStatus(message, className) {
      status.textContent = message;
      status.className = "status " + className;
    }

    function enableInteractionButtons() {
      sendBtn.disabled = false;
      likeBtn.disabled = false;
      starBalloonBtn.disabled = false;
      fanMembershipBtn.disabled = false; // Enable fan membership button
    }

    function disableInteractionButtons() {
      sendBtn.disabled = true;
      likeBtn.disabled = true;
      starBalloonBtn.disabled = true;
      fanMembershipBtn.disabled = true; // Disable fan membership button
    }

    function appendChatMessage(from, message, isFan = false) { // Add isFan parameter
      const chatMessageElem = document.createElement("div");
      chatMessageElem.classList.add("chat-message");
      let senderText = from;
      if (isFan) {
          senderText = `[Ìå¨]${from}`; // Prepend [Ìå¨] if fan
          chatMessageElem.classList.add("fan"); // Add class for fan styling
      }
      chatMessageElem.innerHTML = `<strong>${senderText}:</strong> ${message}`;
      chatLog.appendChild(chatMessageElem);
      chatLog.scrollTop = chatLog.scrollHeight; // Ïä§ÌÅ¨Î°§ÏùÑ Ìï≠ÏÉÅ ÏµúÌïòÎã®ÏúºÎ°ú
    }

    function appendSystemMessage(message) {
      const systemMessageElem = document.createElement("div");
      systemMessageElem.classList.add("system-message");
      systemMessageElem.textContent = message;
      chatLog.appendChild(systemMessageElem);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function appendEffectMessage(message) {
      const effectMessageElem = document.createElement("div");
      effectMessageElem.classList.add("effect-message");
      effectMessageElem.textContent = message;
      chatLog.appendChild(effectMessageElem);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function handleLikeUpdate(data) {
      appendEffectMessage(`‚ù§Ô∏è ${data.from}${data.isFan ? '(Ìå¨)' : ''}ÎãòÏù¥ Ï¢ãÏïÑÏöîÎ•º ÎàåÎ†ÄÏäµÎãàÎã§!`); // Show fan status
    }

    function handleStarBalloon(data) {
      appendEffectMessage(`‚≠ê ${data.from}${data.isFan ? '(Ìå¨)' : ''}ÎãòÏù¥ Î≥ÑÌíçÏÑ† ${data.count}Í∞úÎ•º Î≥¥ÎÉàÏäµÎãàÎã§!`); // Show fan status
    }

    function handleNicknameChange(data) {
      const isViewer = data.viewerId === viewerId;
      const displayNickname = data.isFan ? `[Ìå¨]${data.newNickname}` : data.newNickname;
      if (isViewer) {
          appendSystemMessage(`üìù ÎãâÎÑ§ÏûÑÏùÑ "${displayNickname}"Î°ú Î≥ÄÍ≤ΩÌñàÏäµÎãàÎã§.`);
      } else {
          const oldDisplayNickname = data.isFan ? `[Ìå¨]${data.oldNickname}` : data.oldNickname;
          appendSystemMessage(`üìù ${oldDisplayNickname}ÎãòÏù¥ ÎãâÎÑ§ÏûÑÏùÑ "${displayNickname}"Î°ú Î≥ÄÍ≤ΩÌñàÏäµÎãàÎã§.`);
      }
    }

    function handleFanStatusUpdate(data) { // New function to handle fan status updates from server
        if (data.viewerId === viewerId) {
            isFan = data.isFan;
            localStorage.setItem(`isFan_${viewerId}`, isFan); // Persist fan status
            updateFanMembershipButtonText();
            appendSystemMessage(`üíú ${isFan ? 'Ìå¨ Í∞ÄÏûÖÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!' : 'Ìå¨ Í∞ÄÏûÖÏù¥ Ìï¥Ï†úÎêòÏóàÏäµÎãàÎã§.'}`);
        } else {
            const statusText = data.isFan ? 'Ìå¨Ïù¥ ÎêòÏóàÏäµÎãàÎã§!' : 'Ìå¨ Í∞ÄÏûÖÏùÑ Ìï¥Ï†úÌñàÏäµÎãàÎã§.';
            appendSystemMessage(`üíú ${data.nickname}ÎãòÏù¥ ${statusText}`);
        }
        // Update member list to reflect fan status change immediately
        // This might be redundant if room-members message is also sent by server, but ensures consistency
        // A better approach might be to just re-call updateViewerList if a full list is sent.
        // For now, let's rely on broadcastRoomMembers from server to update the list.
    }

    function updateViewerList(members, senderNickname) { // Add senderNickname parameter
      activeViewersList.innerHTML = '';
      viewerCountDisplay.textContent = members.length;

      // Add sender to the list
      if (senderNickname) {
        const li = document.createElement("li");
        li.textContent = `üé• ${senderNickname} (ÏÜ°Ïã†Ïûê)`;
        activeViewersList.appendChild(li);
      }

      members.forEach(member => {
          const li = document.createElement("li");
          let displayName = member.nickname;
          if (member.isFan) {
              displayName = `[Ìå¨]${member.nickname}`;
              li.classList.add("fan"); // Add class for fan styling
          }
          li.textContent = (member.viewerId === viewerId) ? `${displayName} (ÎÇò)` : displayName;
          li.classList.add("viewer-item"); // Add a class for all viewer items
          activeViewersList.appendChild(li);
      });
    }

    function updateFanMembershipButtonText() { // New function to update button text
        fanMembershipBtn.textContent = isFan ? 'üíú Ìå¨ Í∞ÄÏûÖ Ìï¥Ï†ú' : 'üíú Ìå¨ Í∞ÄÏûÖ';
    }


    // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
    enterRoomBtn.addEventListener("click", () => {
      const newRoomId = roomIdInput.value.trim();
      if (newRoomId && isWsConnected) {
        currentRoomId = newRoomId;
        displayRoomId.textContent = currentRoomId;
        hasEnteredRoom = true;
        
        // When entering room, send current nickname and fan status
        ws.send(JSON.stringify({ 
          type: "enterRoom", 
          roomId: currentRoomId, 
          viewerId: viewerId, 
          nickname: currentNickname, 
          isFan: isFan 
        }));
        
        updateStatus(`Î∞© "${currentRoomId}"Ïóê ÏûÖÏû•. ÏÜ°Ïã†Ïûê ÎåÄÍ∏∞ Ï§ë...`, "status-waiting");
        console.log(`‚úÖ Î∞© ÏûÖÏû•: ${currentRoomId}`);
        enableInteractionButtons();
        appendSystemMessage(`Î∞© "${currentRoomId}"Ïóê ÏûÖÏû•ÌñàÏäµÎãàÎã§.`);
      } else {
        alert("Ïú†Ìö®Ìïú Î∞© IDÎ•º ÏûÖÎ†•ÌïòÍ≥† WebSocketÏù¥ Ïó∞Í≤∞ÎêòÏñ¥ ÏûàÏñ¥Ïïº Ìï©ÎãàÎã§.");
      }
    });

    roomIdInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        enterRoomBtn.click();
      }
    });

    changeNicknameBtn.addEventListener("click", () => {
      const newNickname = nicknameInput.value.trim();
      if (newNickname && newNickname !== currentNickname) {
        const oldNickname = currentNickname;
        currentNickname = newNickname;
        localStorage.setItem('viewerNickname', currentNickname); // Persist nickname
        // Send nickname change to server
        ws.send(JSON.stringify({
          type: "nickname-change",
          viewerId: viewerId,
          oldNickname: oldNickname,
          newNickname: newNickname,
          roomId: currentRoomId
        }));
      } else if (!newNickname) {
        alert("ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
      }
    });

    nicknameInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        changeNicknameBtn.click();
      }
    });

    likeBtn.addEventListener("click", () => {
      if (hasEnteredRoom) {
        ws.send(JSON.stringify({ type: "like", roomId: currentRoomId, from: currentNickname, fromId: viewerId, isFan: isFan }));
        // Local feedback for immediate response
        handleLikeUpdate({ from: currentNickname, fromId: viewerId, isFan: isFan });
      }
    });

    starBalloonBtn.addEventListener("click", () => {
      if (hasEnteredRoom) {
        const count = parseInt(starBalloonInput.value, 10);
        if (isNaN(count) || count <= 0) {
          alert("Ïú†Ìö®Ìïú Î≥ÑÌíçÏÑ† Í∞úÏàòÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
          return;
        }
        ws.send(JSON.stringify({ type: "star-balloon", roomId: currentRoomId, count: count, from: currentNickname, fromId: viewerId, isFan: isFan }));
        // Local feedback for immediate response
        handleStarBalloon({ from: currentNickname, count: count, fromId: viewerId, isFan: isFan });
      }
    });
    
    starBalloonInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        starBalloonBtn.click();
      }
    });

    sendBtn.addEventListener("click", () => {
      if (hasEnteredRoom) {
        const message = chatInput.value.trim();
        if (message) {
          ws.send(JSON.stringify({ type: "chat", message: message, roomId: currentRoomId, from: currentNickname, fromId: viewerId, isFan: isFan }));
          // Local echo for immediate feedback
          // appendChatMessage(currentNickname, message, isFan);
          chatInput.value = "";
        }
      }
    });

    chatInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        sendBtn.click();
      }
    });

    fanMembershipBtn.addEventListener("click", () => { // New event listener for fan membership button
      if (hasEnteredRoom) {
          isFan = !isFan; // Toggle fan status
          localStorage.setItem(`isFan_${viewerId}`, isFan); // Persist fan status
          ws.send(JSON.stringify({ type: "fan-membership", roomId: currentRoomId, viewerId: viewerId, isFan: isFan }));
          updateFanMembershipButtonText(); // Update button text immediately
          // Local feedback
          appendSystemMessage(`üíú Ìå¨ Í∞ÄÏûÖÏùÑ ${isFan ? 'ÏöîÏ≤≠ÌñàÏäµÎãàÎã§.' : 'Ìï¥Ï†ú ÏöîÏ≤≠ÌñàÏäµÎãàÎã§.'}`);
      } else {
          alert("Î®ºÏ†Ä Î∞©Ïóê ÏûÖÏû•Ìï¥Ï£ºÏÑ∏Ïöî!");
      }
    });


    // ÌéòÏù¥ÏßÄ Ï¢ÖÎ£å Ïãú Ï†ïÎ¶¨
    window.addEventListener("beforeunload", () => {
      if (pc) {
        pc.close();
      }
      ws.close();
    });

    // Ï¥àÍ∏∞ ÏÉÅÌÉú ÏÑ§Ï†ï
    disableInteractionButtons();
    // if (!currentNickname) { // Only prompt if no nickname is set
    //   currentNickname = prompt("ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:", "ÏùµÎ™Ö") || "ÏùµÎ™Ö";
    //   nicknameInput.value = currentNickname;
    //   localStorage.setItem('viewerNickname', currentNickname);
    // }
  </script>
</body>
</html>