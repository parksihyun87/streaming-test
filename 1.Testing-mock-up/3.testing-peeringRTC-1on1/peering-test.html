<!DOCTYPE html>
<html>
<head>
  <title>WebRTC 1:1 ì˜ˆì œ</title>
</head>
<body>
  <h2>ğŸ”´ ë¡œì»¬ (ë‚´ í™”ë©´)</h2>
  <video id="localVideo" autoplay playsinline muted></video>

  <h2>ğŸŸ¢ ìƒëŒ€ í™”ë©´</h2>
  <video id="remoteVideo" autoplay playsinline></video>

  <script>
    let localStream;
    const pc = new RTCPeerConnection();
    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    const isInitiator = window.location.hash === "#1";
    let ws;

    // 1. ë¡œì»¬ ë¯¸ë””ì–´ ê°€ì ¸ì˜¤ê¸° â†’ rtcpeerconnectionì— íŠ¸ë™ ì¶”ê°€ â†’ ê·¸ í›„ WebSocket ì—°ê²°// ë¹„ë””ì˜¤ ì˜¤ë””ì˜¤ë¥¼ webrtc pcì— ë“±ë¡
    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      .then(stream => {
        localStream = stream;
        localVideo.srcObject = stream;
        stream.getTracks().forEach(track => pc.addTrack(track, stream));

        startWebSocket(); // ë°˜ë“œì‹œ ì´í›„ì— ì‹¤í–‰!
      });

    // 2. ìƒëŒ€ íŠ¸ë™ ìˆ˜ì‹  
    pc.ontrack = (event) => {
      remoteVideo.srcObject = event.streams[0];
    };

    // 3. ì—°ê²° ìƒíƒœ ë¡œê·¸// ì›¹ì†Œì¼€íŒ…ìœ¼ë¡œ ì‹œê·¸ë„ë§ ë©”ì„¸ì§€ êµí™˜ìœ¼ë¡œ iceì •ë³´ ì—°ë™í›„ p2p ì¤€ë¹„
    pc.onconnectionstatechange = () => {
      console.log("ğŸ’¡ ì—°ê²° ìƒíƒœ:", pc.connectionState);
    };

    function startWebSocket() {
      ws = new WebSocket("ws://localhost:8080");

      ws.onopen = async () => {
        if (isInitiator) {
          const offer = await pc.createOffer();
          await pc.setLocalDescription(offer);
          ws.send(JSON.stringify(offer));
        }
      };

      ws.onmessage = async (msg) => {
        const data = JSON.parse(msg.data);

        if (data.type === "offer") {
          await pc.setRemoteDescription(new RTCSessionDescription(data));
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          ws.send(JSON.stringify(pc.localDescription));

        } else if (data.type === "answer") {
          await pc.setRemoteDescription(new RTCSessionDescription(data));

        } else if (data.type === "candidate") {
          try {
            await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
          } catch (e) {
            console.error("âŒ ICE ì¶”ê°€ ì˜¤ë¥˜:", e);
          }
        }
      };
        //iceí›„ë³´ì§€ ë„¤íŠ¸ì›Œí¬ ì •ë³´ ì „ì†¡
      pc.onicecandidate = (event) => {
        if (event.candidate) {
          ws.send(JSON.stringify({ type: "candidate", candidate: event.candidate }));
        }
      };
    }
  </script>
</body>
</html>
